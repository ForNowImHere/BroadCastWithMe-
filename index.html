<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Screen Share Control</title>
<style>
  body { background: #111; color: #eee; font-family: monospace; }
  #login { margin-bottom: 1rem; }
  label, input { display: block; margin: 0.3rem 0; }
  #log { height: 4rem; overflow-y: auto; background: #222; padding: 0.5rem; margin-bottom: 1rem; }
  canvas { border: 1px solid #444; background: black; cursor: crosshair; }
</style>
</head>
<body>

<h2>Screen Share Control</h2>

<div id="login">
  <label>Username:<input id="username" value="keenbean" /></label>
  <label>Password:<input id="password" type="password" value="supersecret" /></label>
  <label>Access Code:<input id="code" placeholder="Waiting for code..." readonly /></label>
  <button id="connectBtn">Connect</button>
</div>

<div id="log"></div>

<canvas id="screen" width="800" height="450"></canvas>

<script>
  let ws;
  const logDiv = document.getElementById("log");
  const canvas = document.getElementById("screen");
  const ctx = canvas.getContext("2d");
  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");
  const codeInput = document.getElementById("code");
  const connectBtn = document.getElementById("connectBtn");

  function log(msg) {
    logDiv.textContent += msg + "\n";
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  function connect() {
    if (ws) ws.close();

    // Replace this with your actual ngrok URL + port (use wss:// for secure)
    // Example: 'wss://8205375fe07a.ngrok-free.app'
    const ngrokUrl = "wss://8205375fe07a.ngrok-free.app"; 

    ws = new WebSocket(ngrokUrl);

    ws.onopen = () => {
      log("WebSocket connected.");
    };

    ws.onmessage = (event) => {
      let msg = JSON.parse(event.data);

      if (msg.type === "auth_code_generated") {
        codeInput.value = msg.code;
        log("New access code received: " + msg.code);
      } 
      else if (msg.type === "request_auth") {
        // Send auth details
        ws.send(JSON.stringify({
          username: usernameInput.value,
          password: passwordInput.value,
          code: codeInput.value
        }));
        log("Sent auth data.");
      }
      else if (msg.type === "auth_result") {
        if (msg.success) {
          log("Authentication successful! Welcome!");
        } else {
          log("Auth failed: " + msg.message);
        }
      }
      else if (msg.type === "screenshot") {
        const img = new Image();
        img.src = "data:image/jpeg;base64," + msg.data;
        img.onload = () => {
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        };
      }
      else if(msg.type === "control_timeout") {
        log("Control expired.");
      }
    };

    ws.onerror = (e) => {
      log("WebSocket error: " + e.message);
    };

    ws.onclose = () => {
      log("WebSocket closed.");
    };
  }

  connectBtn.onclick = connect;

  // Send mouse move and click commands
  canvas.addEventListener("mousemove", (e) => {
    if (!ws || ws.readyState !== WebSocket.OPEN) return;
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) * (1920 / canvas.width)); // Assuming 1920x1080 screen - adjust as needed
    const y = Math.floor((e.clientY - rect.top) * (1080 / canvas.height));
    ws.send(JSON.stringify({ type: "mouse_move", x, y }));
  });

  canvas.addEventListener("click", (e) => {
    if (!ws || ws.readyState !== WebSocket.OPEN) return;
    ws.send(JSON.stringify({ type: "click" }));
  });
</script>

</body>
</html>
