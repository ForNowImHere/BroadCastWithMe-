<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Screen Share Control</title>
<style>
  body { font-family: Arial, sans-serif; background:#222; color:#eee; margin:0; padding:20px; }
  #login { margin-bottom: 15px; }
  label { display:block; margin: 8px 0 4px; }
  input { padding: 6px; width: 200px; }
  button { margin-top: 10px; padding: 8px 12px; }
  #messages { margin-top: 10px; height: 100px; overflow-y: auto; background:#333; padding: 8px; border-radius: 5px; }
  #screen { display:block; margin-top: 15px; max-width: 100%; border: 2px solid #555; cursor: crosshair; }
</style>
</head>
<body>

<h1>Screen Share Control</h1>

<div id="login">
  <label>Username:</label>
  <input id="username" type="text" placeholder="Username" />
  <label>Password:</label>
  <input id="password" type="password" placeholder="Password" />
  <label>Access Code:</label>
  <input id="code" type="text" placeholder="Enter code" />
  <button id="connectBtn">Connect</button>
</div>

<div id="messages"></div>

<img id="screen" alt="Shared screen will appear here" />

<script>
  const wsUrl = "ws://localhost:8765"; // Change to your server URL if needed
  let ws;
  let controlAllowed = false;
  const messages = document.getElementById("messages");
  const screenImg = document.getElementById("screen");
  const connectBtn = document.getElementById("connectBtn");

  function logMessage(msg) {
    messages.innerHTML += msg + "<br>";
    messages.scrollTop = messages.scrollHeight;
  }

  function sendJSON(obj) {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify(obj));
    }
  }

  connectBtn.onclick = () => {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    const code = document.getElementById("code").value.trim();
    if (!username || !password || !code) {
      alert("Please fill in all fields.");
      return;
    }

    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
      logMessage("WebSocket connected, requesting auth...");
      sendJSON({ username, password, code });
    };

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);

        if (data.type === "request_auth") {
          logMessage("Server requests authentication...");
          // Send auth info
          sendJSON({ username, password, code });

        } else if (data.type === "auth_code_generated") {
          logMessage("Access code generated: " + data.code);

        } else if (data.type === "auth_result") {
          if (data.success) {
            logMessage("Auth success: " + data.message);
            controlAllowed = data.control_allowed || false;
          } else {
            logMessage("Auth failed: " + data.message);
            controlAllowed = false;
          }

        } else if (data.type === "screenshot") {
          screenImg.src = "data:image/jpeg;base64," + data.data;

        } else if (data.type === "control_denied") {
          logMessage("Control denied: " + data.reason);

        } else if (data.type === "control_timeout") {
          logMessage("Control timeout: " + data.message);
          controlAllowed = false;
        }

      } catch (e) {
        // Not JSON, maybe raw image data? Ignore.
      }
    };

    ws.onclose = () => {
      logMessage("WebSocket connection closed.");
      controlAllowed = false;
    };

    ws.onerror = (e) => {
      logMessage("WebSocket error: " + e.message);
    };
  };

  // Send mouse control commands if allowed
  screenImg.addEventListener("mousemove", (e) => {
    if (!controlAllowed) return;
    const rect = screenImg.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * window.screen.width;
    const y = ((e.clientY - rect.top) / rect.height) * window.screen.height;
    sendJSON({ type: "mouse_move", x: Math.floor(x), y: Math.floor(y) });
  });

  screenImg.addEventListener("click", () => {
    if (!controlAllowed) return;
    sendJSON({ type: "click" });
  });
</script>

</body>
</html>
